<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand -->
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>custom_estimator • tfestimators</title>
  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq"
    crossorigin="anonymous"></script><!-- Bootstrap -->
  <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet"
    crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script><!-- Font Awesome icons -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
    integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
  <!-- pkgdown -->
  <link href="../../pkgdown.css" rel="stylesheet">
  <script src="../../jquery.sticky-kit.min.js"></script>
  <script src="../../pkgdown.js"></script>
  <link href="../../extra.css" rel="stylesheet">
  <script src="../../extra.js"></script><!-- mathjax -->
  <script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body>
  <div class="container template-vignette">
    <header>
      <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../index.html">tfestimators</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li>
                <a href="../../index.html">Home</a>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                  Using

                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li class="dropdown-header">Getting Started</li>
                  <li>
                    <a href="../../articles/estimator_basics.html">Estimator Basics</a>
                  </li>
                  <li>
                    <a href="../../articles/input_functions.html">Input Functions</a>
                  </li>
                  <li>
                    <a href="../../articles/feature_columns.html">Feature Columns</a>
                  </li>
                  <li class="divider">
                  <li class="dropdown-header">Advanced</li>
                  <li>
                    <a href="../../articles/run_hooks.html">Run Hooks</a>
                  </li>
                  <li>
                    <a href="../../articles/creating_estimators.html">Custom Estimators</a>
                  </li>
                  <li>
                    <a href="../../articles/simplify_function.html">Simplify Function</a>
                  </li>
                  <li>
                    <a href="../../articles/layers.html">TensorFlow Layers</a>
                  </li>
                  <li>
                    <a href="../../articles/tensorboard.html">TensorBoard Visualization</a>
                  </li>
                  <li>
                    <a href="../../articles/parsing_spec.html">Parsing Utilities</a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../articles/examples/index.html">Examples</a>
              </li>
              <li>
                <a href="../../reference/index.html">Reference</a>
              </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li>
                <a href="https://github.com/rstudio/tfestimators">
                  <span class="fa fa-github"></span>

                </a>
              </li>
            </ul>
          </div>
          <!--/.nav-collapse -->
        </div>
        <!--/.container -->
      </div>
      <!--/.navbar -->


    </header>
    <div class="row">
      <div class="col-md-9">
        <div class="page-header toc-ignore">
          <h1>custom_estimator</h1>

        </div>



        <div class="contents">
          <div class="source-ref">
            <p><span class="caption">Source: </span><a
                href="https://github.com/rstudio/tfestimators/blob/main/vignettes/examples/custom_estimator.R"
                class="uri">https://github.com/rstudio/tfestimators/blob/main/vignettes/examples/custom_estimator.R</a>
            </p>
          </div>
          <p>In this article, we’ll develop a custom estimator to be used with the <a
              href="https://archive.ics.uci.edu/ml/datasets/abalone">Abalone dataset</a>. This dataset provides
            information on the physical characteristics of a number of abalones (a type of sea snail), and use these
            characteristics to predict the number of rings in the shell. As described at <a
              href="https://archive.ics.uci.edu/ml/machine-learning-databases/abalone/abalone.names"
              class="uri">https://archive.ics.uci.edu/ml/machine-learning-databases/abalone/abalone.names</a>:</p>
          <blockquote>
            <p>Predicting the age of abalone from physical measurements. The age of abalone is determined by cutting the
              shell through the cone, staining it, and counting the number of rings through a microscope – a boring and
              time-consuming task. Other measurements, which are easier to obtain, are used to predict the age. Further
              information, such as weather patterns and location (hence food availability) may be required to solve the
              problem.</p>
          </blockquote>
          <div class="sourceCode">
            <pre
              class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tfestimators)</code></pre>
          </div>
          <p>We’ll start by defining a function that will download and save the various abalone datasets we’ll use here.
            These datasets are hosted freely on the TensorFlow website.</p>
          <div class="sourceCode">
            <pre class="sourceCode r"><code class="sourceCode r">maybe_download_abalone &lt;-<span class="st"> </span><span class="cf">function</span>(train_data_path, test_data_path, predict_data_path, column_names_to_assign) {
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(train_data_path) <span class="op">||</span><span class="st"> </span><span class="op">!</span><span class="kw">file.exists</span>(test_data_path) <span class="op">||</span><span class="st"> </span><span class="op">!</span><span class="kw">file.exists</span>(predict_data_path)) {
    <span class="kw">cat</span>(<span class="st">"Downloading abalone data ..."</span>)
    train_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">"http://download.tensorflow.org/data/abalone_train.csv"</span>, <span class="dt">header =</span> <span class="ot">FALSE</span>)
    test_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">"http://download.tensorflow.org/data/abalone_test.csv"</span>, <span class="dt">header =</span> <span class="ot">FALSE</span>)
    predict_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">"http://download.tensorflow.org/data/abalone_predict.csv"</span>, <span class="dt">header =</span> <span class="ot">FALSE</span>)
    <span class="kw">colnames</span>(train_data) &lt;-<span class="st"> </span>column_names_to_assign
    <span class="kw">colnames</span>(test_data) &lt;-<span class="st"> </span>column_names_to_assign
    <span class="kw">colnames</span>(predict_data) &lt;-<span class="st"> </span>column_names_to_assign
    <span class="kw">write.csv</span>(train_data, train_data_path, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)
    <span class="kw">write.csv</span>(test_data, test_data_path, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)
    <span class="kw">write.csv</span>(predict_data, predict_data_path, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)
  } <span class="cf">else</span> {
    train_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(train_data_path, <span class="dt">header =</span> <span class="ot">TRUE</span>)
    test_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(test_data_path, <span class="dt">header =</span> <span class="ot">TRUE</span>)
    predict_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(predict_data_path, <span class="dt">header =</span> <span class="ot">TRUE</span>)
  }
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">train_data =</span> train_data, <span class="dt">test_data =</span> test_data, <span class="dt">predict_data =</span> predict_data))
}</code></pre>
          </div>
          <p>Because the raw datasets are not supplied with column names, we define them explicitly here (in the order
            they appear in the dataset), and apply them when the datasets are downloaded.</p>
          <div class="sourceCode">
            <pre class="sourceCode r"><code class="sourceCode r">COLNAMES &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"length"</span>, <span class="st">"diameter"</span>, <span class="st">"height"</span>, <span class="st">"whole_weight"</span>, <span class="st">"shucked_weight"</span>, <span class="st">"viscera_weight"</span>, <span class="st">"shell_weight"</span>, <span class="st">"num_rings"</span>)

downloaded_data &lt;-<span class="st"> </span><span class="kw">maybe_download_abalone</span>(
  <span class="kw">file.path</span>(<span class="kw">getwd</span>(), <span class="st">"train_abalone.csv"</span>),
  <span class="kw">file.path</span>(<span class="kw">getwd</span>(), <span class="st">"test_abalone.csv"</span>),
  <span class="kw">file.path</span>(<span class="kw">getwd</span>(), <span class="st">"predict_abalone.csv"</span>),
  COLNAMES
)
train_data &lt;-<span class="st"> </span>downloaded_data<span class="op">$</span>train_data
test_data &lt;-<span class="st"> </span>downloaded_data<span class="op">$</span>test_data
predict_data &lt;-<span class="st"> </span>downloaded_data<span class="op">$</span>predict_data</code></pre>
          </div>
          <p>We now have the abalone datasets available locally. Now, we begin by defining an input function for our
            soon-to-be-defined estimator. Here, we define an <strong>input function generator</strong> – this function
            accepts a dataset, and returns an input function that pulls data from the associated dataset. Using this, we
            can generate input functions for each of our datasets easily.</p>
          <p>Note that we are attempting to predict the <code>num_rings</code> variable, and accept all other variables
            contained within the dataset as potentially associated features.</p>
          <div class="sourceCode">
            <pre class="sourceCode r"><code class="sourceCode r">abalone_input_fn &lt;-<span class="st"> </span><span class="cf">function</span>(dataset) {
  <span class="kw"><a href="../../reference/input_fn.html">input_fn</a></span>(dataset, <span class="dt">features =</span> <span class="op">-</span>num_rings, <span class="dt">response =</span> num_rings)
}</code></pre>
          </div>
          <p>Next, we define our custom model function. Canned estimators provided by TensorFlow / the
            <code>tfestimators</code> package come with pre-packaged model functions; when you wish to define your own
            custom estimator, you must provide your own model function. This is the function responsible for
            constructing the actual neural network to be used in your model, and should be created by composing
            TensorFlow’s primitives for layers together.
          </p>
          <p>We’ll construct a network with two fully-connected hidden layers, and a final output layer. After you’ve
            constructed your neywork and defined the optimizer + loss functions you wish to use, you can call the
            <code><a href="../../reference/estimator_spec.html">estimator_spec()</a></code> function to construct your
            estimator.
          </p>
          <p>The model function should accept the following parameters:</p>
          <ul>
            <li>
              <p><code>features</code>: The feature columns (normally supplied by an input function);</p>
            </li>
            <li>
              <p><code>labels</code>: The true labels, to be used for computing the loss;</p>
            </li>
            <li>
              <p><code>mode</code>: A key that specifies whether training, evaluation, or prediction is being performs.
              </p>
            </li>
            <li>
              <p><code>params</code>: A set of custom parameters; typically supplied by the user of your custom
                estimator when instances of this estimator are created. (For example, we’ll see later that the
                <code>learning_rate</code> is supplied through here.)
              </p>
            </li>
            <li>
              <p><code>config</code>: Runtime configuration values; typically unneeded by custom estimators, but can be
                useful if you need to introspect the state of the associated TensorFlow session.</p>
            </li>
          </ul>
          <div class="sourceCode">
            <pre class="sourceCode r"><code class="sourceCode r">model_fn &lt;-<span class="st"> </span><span class="cf">function</span>(features, labels, mode, params, config) {

  <span class="co"># Connect the first hidden layer to input layer</span>
  first_hidden_layer &lt;-<span class="st"> </span>tf<span class="op">$</span>layers<span class="op">$</span><span class="kw">dense</span>(features, 10L, <span class="dt">activation =</span> tf<span class="op">$</span>nn<span class="op">$</span>relu)

  <span class="co"># Connect the second hidden layer to first hidden layer with relu</span>
  second_hidden_layer &lt;-<span class="st"> </span>tf<span class="op">$</span>layers<span class="op">$</span><span class="kw">dense</span>(first_hidden_layer, 10L, <span class="dt">activation =</span> tf<span class="op">$</span>nn<span class="op">$</span>relu)

  <span class="co"># Connect the output layer to second hidden layer (no activation fn)</span>
  output_layer &lt;-<span class="st"> </span>tf<span class="op">$</span>layers<span class="op">$</span><span class="kw">dense</span>(second_hidden_layer, 1L)

  <span class="co"># Reshape output layer to 1-dim Tensor to return predictions</span>
  predictions &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">reshape</span>(output_layer, <span class="kw">list</span>(<span class="op">-</span>1L))

  <span class="co"># Provide an estimator spec for prediction mode</span>
  <span class="cf">if</span> (mode <span class="op">==</span><span class="st"> "infer"</span>) <span class="kw">return</span>(<span class="kw"><a href="../../reference/estimator_spec.html">estimator_spec</a></span>(<span class="dt">mode =</span> mode, <span class="dt">predictions =</span>  <span class="kw">list</span>(<span class="dt">ages =</span> predictions)))

  <span class="co"># Calculate loss using mean squared error</span>
  loss &lt;-<span class="st"> </span>tf<span class="op">$</span>losses<span class="op">$</span><span class="kw">mean_squared_error</span>(labels, predictions)

  eval_metric_ops &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">rmse =</span> tf<span class="op">$</span>metrics<span class="op">$</span><span class="kw">root_mean_squared_error</span>(
    tf<span class="op">$</span><span class="kw">cast</span>(labels, tf<span class="op">$</span>float64), predictions
  ))

  optimizer &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">GradientDescentOptimizer</span>(<span class="dt">learning_rate =</span> params<span class="op">$</span>learning_rate)
  train_op &lt;-<span class="st"> </span>optimizer<span class="op">$</span><span class="kw">minimize</span>(<span class="dt">loss =</span> loss, <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_global_step</span>())

  <span class="co"># Provide an estimator spec for evaluation and training modes.</span>
  <span class="kw">return</span>(<span class="kw"><a href="../../reference/estimator_spec.html">estimator_spec</a></span>(
    <span class="dt">mode =</span> mode,
    <span class="dt">loss =</span> loss,
    <span class="dt">train_op =</span> train_op,
    <span class="dt">eval_metric_ops =</span> eval_metric_ops
  ))
}</code></pre>
          </div>
          <p>We’ve defined our model function – we can now use the
            <code><a href="../../reference/estimator.html">estimator()</a></code> function to create an instance of the
            estimator we’ve defined, using that model function.
          </p>
          <div class="sourceCode">
            <pre
              class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/estimator.html">estimator</a></span>(model_fn, <span class="dt">params =</span> <span class="kw">list</span>(<span class="dt">learning_rate =</span> <span class="fl">0.001</span>))</code></pre>
          </div>
          <p>Now, we can train, evaluate, and predict using our estimator.</p>
          <div class="sourceCode">
            <pre
              class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/tensorflow/topics/train">train</a></span>(model, <span class="dt">input_fn =</span> <span class="kw">abalone_input_fn</span>(train_data))
<span class="kw"><a href="http://www.rdocumentation.org/packages/tensorflow/topics/evaluate">evaluate</a></span>(model, <span class="dt">input_fn =</span> <span class="kw">abalone_input_fn</span>(test_data))
<span class="kw">predict</span>(model, <span class="dt">input_fn =</span> <span class="kw">abalone_input_fn</span>(predict_data))</code></pre>
          </div>
        </div>
      </div>

      <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

    </div>


    <footer>
      <div class="copyright">
        <p>Developed by Yuan Tang, JJ Allaire, Kevin Ushey, <a href="https://www.rstudio.com"><img
              src="http://tidyverse.org/rstudio-logo.svg" height="24"></a>.</p>
      </div>

      <div class="pkgdown">
        <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
      </div>

    </footer>
  </div>

</body>

</html>
